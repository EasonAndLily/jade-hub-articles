# 高效能软件架构

![software-architecture.jpg](https://s1.locimg.com/2024/10/04/03cc426870ee1.jpg)

如何提高效能也成为近几年企业或者团队管理者的热门话题。在软件架构领域，如何设计一套合理的架构从而提升团队研发效能也是一个值得探讨的问题。

软件架构作为软件系统的基石，对于构建高效稳定的软件系统具有重要意义，一个好的软件架构能够确保系统的稳定性、可维护性和可扩展性，降低系统的风险和成本，从而极大提高软件研发效能；相反，一个设计有缺陷的软件架构，不仅让系统的扩展性变差，极大的增加项目的维护成本，让团队陷入挣扎的泥潭，拖累团队的效率。

那什么是架构呢？ IEEE给出了架构的定义：
> the fundamental organization of a system, embodied in its components, their relationships to each other and the environment, and the principles governing its design and evolution         --ANSI/IEEE

系统的基本组织，体现在系统的组件、组件间关系和环境关系，以及控制系统设计和发展的原则。

上面的定义听起来有些抽象，简单看来就是通过一系列的原则和实践，定义系统组件和组件之间、组件和环境之间的关系的基本构成。

而大师 Martin Fowler和Ralph Johnson对于架构的定义有着更加简洁的抽象：**重要并且难以改变的决策！**
> Software Architecture = Important and hard to change decisions   --Martin Fowler
>
> The software architecture is the important stuff ! Whatever it is !   --Ralph Johnson

***所以软件架构就是重要的东西，不论它是什么！***

下面我们就从效能的角度来看，架构对于效能的影响。

## 分层架构

分层架构（layered architecture）是最常见的软件架构，也是事实上的标准架构，比如计算机网络的7层架构，就是典型的分层架构。很多时候，如果你不知道要用什么架构，那就用它。

这种架构将软件分成N个层，每一层都有清晰的职责(角色和分工)，不需要知道其他层的细节，层与层之间通过接口通信，请求都是依次通过每个层进行处理，最终又依次返回。虽然没有明确约定，软件一定要分成多少层，但是三/四层的结构最常见。

![layer-architecture.jpg](https://s1.locimg.com/2024/10/04/f5dd71bf593c9.jpg)

* 表现层（presentation）： 用户展示界面，负责视觉和用户互动，主要是一些视图相关。
* 业务层（business）：实现业务逻辑，是系统的核心组件，代表的业务的核心流程和核心逻辑。
* 持久层（persistence）：提供数据增删改查支持，比如SQL语句就放在这一层。
* 存储层（database）：存储数据，主要是一些数据库。

从效能的角度来看，这种架构结构简单，容易理解和开发，不同技能的程序员可以分工，负责不同的层，天然适合大多数软件公司的组织架构，同时每一层都可以独立测试，其他层的接口通过模拟解决。

然而，由于各层之间耦合性较强，一旦环境变化，需要代码调整或增加功能时，必须依次扩展每一层，通常比较麻烦和费时；同时，由于业务层没有通过模型进行设计，导致业务层内部服务之间耦合相当严重，各种业务逻辑纠缠在一起，最终形成一个膨胀层，严重阻塞了软件的可维护性，长期下去研发效能将逐渐降低。

### MVC

为了有效解决分层架构中业务逻辑层(Business Layer)业务关系耦合性强的问题，将业务逻辑层进一步拆分为两层，一层负责接受表现层的请求，封装和组装数据，控制表现层的展示，称之为控制器(Controller), 另一层负责领域逻辑，封装了核心业务模型，我们称之为模型(Model), 这就是MVC(Model View Controller)架构。

![mvc.jpg](https://s1.locimg.com/2024/10/04/fdd632c2e6068.jpg)

本质上来说，MVC架构是分层架构的衍生，对业务逻辑层进一步解耦，使得代码更加易于维护和优化。同时，通过Controller这一层，将视图和业务逻辑进行了解耦，将数据展示和数据生成放到了不同的模块中，易于维护和扩展。

## 六边形架构

随着微服务的兴起，领域驱动设计(DDD)成为微服务划分的主要指导思想，虽然DDD并不要求采用特定的架构风格，因为它是对架构中立的。你可以采用传统的三层式架构，也可以采用REST架构和事件驱动架构等。但是在《实现领域驱动设计》中，作者比较推崇事件驱动架构和六边形（Hexagonal）架构。

六边形架构的设计思想源于Alistair Cockburn在2005年提出的“六边形关系图”理论。在这个理论中，软件系统被视为一个六边形，其中有三组组件构成：**核心业务逻辑（Domain），输入和输出端口（Ports）以及适配器（Adapters）**。这些组件通过一系列接口进行交互，实现内部的业务逻辑，并通过端口和适配器与外部系统进行交互。

在六边形架构中，已经不存在分层的概念，所有组件都是平等的。这主要得益于软件抽象的好处，即各个组件的之间的交互完全通过接口完成，而不是具体的实现细节。正如Robert C. Martin所说：***抽象不应该依赖于细节，细节应该依赖于抽象。**

![hexagonal.jpeg](https://s1.locimg.com/2024/10/07/77a0d899c1edc.jpeg)

软件系统的真正价值在于提供业务功能，我们会将所有的业务功能分解为若干个业务用例，每一次业务用例都表示对软件系统的一次原子操作。软件系统中应该存在这样的组件，他们的作用即以业务用例为单位向外界暴露该系统的业务功能。在DDD中，这样的组件称为应用层（Application Layer）。

领域模型(Domain)位于应用程序的核心部分，外界与领域模型的交互都通过应用层完成，应用层是领域模型的直接客户。然而，应用层中不应该包含有业务逻辑，否则就造成了领域逻辑的泄漏，而应该是很薄的一层，主要起到协调的作用，它所做的只是将业务操作代理给我们的领域模型。同时，如果我们的业务操作有事务需求，那么对于事务的管理应该放在应用层上，因为事务也是以业务用例为单位的。

适配器(Adapters)是连接输入和输出端口与具体实现的桥梁。它们负责将外部世界的请求转换为适合核心业务逻辑处理的数据，并将结果适配为外部系统能够理解的形式。适配器可以是数据库、消息队列、外部服务库或任何其他与外部系统进行交互的方式。

从效能角度来看，六边形架构具有清晰的边界和职责，可以独立于外部接口进行测试和演进，这使得业务逻辑更加内聚到业务领域模型中，极大降低了与外部的耦合性，在以领域为团队职责划分的组织架构中，将领域知识内聚在团队内部，使得团队分工更加明确，业务更加清晰，效率极大提升。

## 洋葱架构

在六边形架构的基础上，2008年Jeffrey Palermo已经提出了具有“分层思想”的洋葱架构。所以，洋葱架构是六边形架构和分层架构的结合体。



## 事件驱动架构